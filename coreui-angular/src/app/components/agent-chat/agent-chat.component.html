<div class="agent-chat-container" cdkDrag cdkDragBoundary="body" [class.minimized]="isMinimized">
  
  <div class="chat-header" cdkDragHandle>
    <div class="header-title">
        <span *ngIf="!isMinimized">ğŸ¤– AI Assistant</span>
        <span *ngIf="isMinimized">ğŸ¤–</span>
        <span *ngIf="!isMinimized" class="status-text" [class.offline]="!isConnected">
            {{ connectionStatus }}
        </span>
    </div>
    
    <div class="header-actions">
      <button *ngIf="autoRunning && !isMinimized" class="btn-stop" (click)="stopAutoRun('User stopped'); $event.stopPropagation()">
        â¹ Stop
      </button>

      <button *ngIf="!isMinimized && !autoRunning && !isReviewing" class="btn-record" [class.recording]="isRecording" (click)="toggleRecording(); $event.stopPropagation()">
        {{ isRecording ? 'â¹ Stop' : 'ğŸ”´ Record' }}
      </button>

      <button class="btn-icon" (click)="toggleMinimize($event)" title="{{ isMinimized ? 'Expand' : 'Minimize' }}" (mousedown)="$event.stopPropagation()">
        {{ isMinimized ? 'â¬œ' : 'â–' }}
      </button>
    </div>
  </div>

  <div class="chat-body" *ngIf="!isMinimized">
    
    <div class="review-overlay" *ngIf="isReviewing">
      <div class="review-header">
        <span>Review: {{ reviewTaskName }}</span>
        <span style="font-size: 11px; font-weight: normal;">{{ reviewSteps.length }} steps</span>
      </div>
      
      <div class="review-list">
        <div class="review-item" *ngFor="let step of reviewSteps; let i = index">
          <span class="step-num">#{{ i + 1 }}</span>
          <div class="step-desc">
            <strong>{{ step.action.type | uppercase }}</strong>: 
            {{ step.element_desc }}
            <span *ngIf="step.action.value"> (Val: {{ step.action.value }})</span>
          </div>
          <button class="step-del-btn" (click)="removeStep(i)" title="Delete step">âœ–</button>
        </div>
        <div *ngIf="reviewSteps.length === 0" style="text-align: center; padding: 20px; color: #999;">
          No steps recorded.
        </div>
      </div>
      
      <div class="review-footer">
        <button class="btn-cancel" (click)="cancelSave()">Discard</button>
        <button class="btn-confirm" (click)="confirmSave()" [disabled]="reviewSteps.length === 0">Save Demo</button>
      </div>
    </div>

    <div class="mode-switcher" *ngIf="!isRecording && !autoRunning">
      <button [class.active]="currentMode === 'chat'" (click)="setMode('chat')">ğŸ’¬ Chat Mode</button>
      <button [class.active]="currentMode === 'task'" (click)="setMode('task')">âš¡ Task Mode</button>
    </div>

    <div class="messages">
      <div *ngFor="let msg of messages" class="msg" [ngClass]="msg.type">
        <div>{{ msg.text }}</div>
        <div *ngIf="msg.type === 'agent' && msg.actionData" class="feedback-actions">
          <button [class.active]="msg.feedback === 'good'" (click)="sendFeedback(msg.id, 'good', msg.actionData)">ğŸ‘</button>
          <button [class.active]="msg.feedback === 'bad'" (click)="sendFeedback(msg.id, 'bad', msg.actionData)">ğŸ‘</button>
        </div>
      </div>
    </div>
    
    <div class="input-area">
      <input [(ngModel)]="inputText" 
             (keyup.enter)="send()" 
             [placeholder]="currentMode === 'chat' ? 'Ask about page...' : 'Enter command...'" 
             [disabled]="autoRunning || isReviewing">
      
      <button class="btn-send" (click)="send()" [disabled]="!inputText.trim() || autoRunning || isReviewing">
        Send
      </button>
    </div>
  </div>
</div>